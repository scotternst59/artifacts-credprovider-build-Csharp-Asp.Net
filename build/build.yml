parameters:
  push: false
  sign: false
  nuspecProperties: ''

steps:
- task: DotNetCoreInstaller@0
  displayName: Use .NET Core sdk 2.1.0
  inputs:
    version: 2.1.300

- task: DotNetCoreCLI@2
  displayName: dotnet restore NuGet.config
  inputs:
    command: restore
    projects: 'CredentialProvider.Microsoft/CredentialProvider.Microsoft.csproj'
    feedsToUse: config
    nugetConfigPath: 'CredentialProvider.Microsoft/NuGet.config'

- ${{ if eq(parameters.sign, 'true') }}:
  - task: ms-vseng.MicroBuildTasks.30666190-6959-11e5-9f96-f56098202fef.MicroBuildSigningPlugin@1
    displayName: Install Signing Plugin
    inputs:
      signType: '$(SignType)'

- task: MSBuild@1
  displayName: Build CredentialProvider
  inputs:
    solution: 'CredentialProvider.Microsoft/CredentialProvider.Microsoft.csproj'
    configuration: '$(BuildConfiguration)'
    msbuildArguments: '/t:rebuild'

- task: DotNetCoreCLI@2
  displayName: dotnet publish netcoreapp2.1
  inputs:
    command: publish
    publishWebProjects: false
    projects: 'CredentialProvider.Microsoft/CredentialProvider.Microsoft.csproj'
    arguments: '--no-build --framework netcoreapp2.1 --configuration $(BuildConfiguration)'
    zipAfterPublish: false
    modifyOutputPath: false

- ${{ if ne(parameters.sign, 'true') }}:
  - task: DotNetCoreCLI@2
    displayName: dotnet test
    inputs:
      command: test
      projects: 'CredentialProvider.Microsoft.Tests/CredentialProvider.Microsoft.Tests.csproj'

- task: MSBuild@1
  displayName: Build VSIX
  inputs:
    solution: 'MicrosoftCredentialProviderVSIX/MicrosoftCredentialProviderVSIX.csproj'
    configuration: '$(BuildConfiguration)'
    msbuildArguments: '/p:OutputPath=$(Build.ArtifactStagingDirectory)\$(BuildConfiguration)\vsix\'

- task: NuGetCommand@2
  displayName: NuGet pack
  inputs:
    command: pack
    packagesToPack: 'CredentialProvider.Microsoft/CredentialProvider.Microsoft.nuspec'
    packDestination: '$(Build.ArtifactStagingDirectory)\$(BuildConfiguration)'
    buildProperties: '${{ parameters.nuspecProperties }}'

- ${{ if eq(parameters.push, 'true') }}:
  - task: DotNetCoreCLI@2
    displayName: dotnet push
    inputs:
      command: push
      packagesToPush: '$(Build.ArtifactStagingDirectory)/$(BuildConfiguration)/*.nupkg'
      publishVstsFeed: '54754426-96db-4f6e-8a3a-64265d1cc147'

- task: PublishBuildArtifacts@1
  displayName: Publish Artifact $(Build.BuildNumber)
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)\$(BuildConfiguration)\'
    ArtifactName: '$(Build.BuildNumber)'
